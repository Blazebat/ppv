<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>PPV Streams</title>
<link rel="icon" href="logo.png">
<style>
  body {
    font-family: Arial, sans-serif;
    background-color: #0a0a0a;
    color: #fff;
    margin: 0;
    padding: 0;
  }
  header {
    display: flex;
    flex-direction: column;
    align-items: center;
    background-color: #111;
    padding: 15px;
  }
  header img {
    height: 50px;
    margin-bottom: 10px;
  }
  #searchBar {
    width: 90%;
    max-width: 500px;
    padding: 10px;
    border-radius: 25px;
    border: none;
    background: #1b1b1b;
    color: #fff;
    font-size: 14px;
    outline: none;
  }
  h2.category-title {
    margin: 20px 20px 10px;
    font-size: 18px;
    border-left: 4px solid #e50914;
    padding-left: 10px;
  }
  .container {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
    gap: 15px;
    padding: 0 20px 20px;
  }
  .card {
    background: #1a1a1a;
    border-radius: 10px;
    overflow: hidden;
    position: relative;
    transition: transform 0.3s ease;
    cursor: pointer;
  }
  .card:hover {
    transform: scale(1.03);
  }
  .card img {
    width: 100%;
    height: 180px;
    object-fit: cover;
  }
  .info {
    padding: 10px;
  }
  .category {
    font-size: 13px;
    opacity: 0.8;
  }
  .title {
    font-size: 16px;
    font-weight: bold;
    margin: 5px 0;
  }
  .timer {
    font-size: 14px;
    color: #ffd700;
    transition: color 0.5s ease;
  }
  .timer.soon {
    color: #00ff99;
    animation: pulse 1s infinite;
  }
  .viewers {
    font-size: 13px;
    opacity: 0.8;
    margin-top: 3px;
  }
  @keyframes pulse {
    0% { opacity: 1; }
    50% { opacity: 0.6; }
    100% { opacity: 1; }
  }
  .live {
    background: red;
    color: white;
    font-size: 12px;
    padding: 3px 6px;
    border-radius: 5px;
    position: absolute;
    top: 10px;
    left: 10px;
    font-weight: bold;
  }
  #playerContainer {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    display: none;
    background: #000;
    z-index: 9999;
  }
  #player {
    width: 100%;
    height: 100%;
    border: none;
  }
  #closeBtn {
    position: absolute;
    top: 15px;
    right: 20px;
    background: rgba(255,0,0,0.9);
    color: #fff;
    border: none;
    padding: 10px 15px;
    font-size: 16px;
    border-radius: 5px;
    cursor: pointer;
    z-index: 10000;
  }
</style>
</head>
<body>
<header>
  <img src="logo.png" alt="Logo">
  <input type="text" id="searchBar" placeholder="Search streams...">
</header>

<div id="streamsContainer"></div>

<div id="playerContainer">
  <button id="closeBtn">Close</button>
  <iframe id="player" allowfullscreen allow="encrypted-media; picture-in-picture"></iframe>
</div>

<script>
let allStreams = [];
let intervalId;

async function loadStreams() {
  const res = await fetch("https://ppv.to/api/streams");
  const data = await res.json();

  allStreams = [];
  data.streams.forEach(cat => {
    const filtered = cat.streams.filter(s => 
      !s.name.toLowerCase().includes("24/7") &&
      !s.name.toLowerCase().includes("master stream test")
    );
    if (filtered.length > 0) {
      allStreams.push({ category: cat.category, streams: filtered });
    }
  });

  displayStreams(allStreams);
  startCountdownUpdates();
}

function displayStreams(streamsGroups) {
  const container = document.getElementById("streamsContainer");
  container.innerHTML = "";
  const now = Math.floor(Date.now()/1000);

  const liveStreams = [];
  const upcomingGroups = [];

  streamsGroups.forEach(group => {
    const upcoming = [];
    group.streams.forEach(s => {
      const isLive = now >= s.starts_at && now <= s.ends_at;
      if (isLive) {
        liveStreams.push({...s, category: group.category});
      } else {
        upcoming.push(s);
      }
    });
    if(upcoming.length>0) upcomingGroups.push({category: group.category, streams: upcoming});
  });

  // LIVE NOW Section
  if(liveStreams.length>0){
    const liveTitle = document.createElement("h2");
    liveTitle.className = "category-title";
    liveTitle.textContent = "üî¥ LIVE NOW";
    container.appendChild(liveTitle);

    const liveGrid = document.createElement("div");
    liveGrid.className = "container";
    liveStreams.forEach(stream=>{
      const card = createCard(stream, true);
      liveGrid.appendChild(card);
    });
    container.appendChild(liveGrid);
  }

  // Upcoming groups
  upcomingGroups.forEach(group=>{
    const sectionTitle = document.createElement("h2");
    sectionTitle.className = "category-title";
    sectionTitle.textContent = group.category;
    container.appendChild(sectionTitle);

    const sectionGrid = document.createElement("div");
    sectionGrid.className = "container";

    group.streams.forEach(stream=>{
      const card = createCard(stream,false);
      sectionGrid.appendChild(card);
    });

    container.appendChild(sectionGrid);
  });
}

function createCard(stream, isLive){
  const card = document.createElement("div");
  card.className = "card";
  card.dataset.startTime = stream.starts_at;
  card.dataset.viewers = stream.viewers || 0;

  const img = document.createElement("img");
  img.src = stream.poster;

  const info = document.createElement("div");
  info.className = "info";

  const catLabel = document.createElement("div");
  catLabel.className = "category";
  catLabel.textContent = stream.category;

  const title = document.createElement("div");
  title.className = "title";
  title.textContent = stream.name;

  const viewers = document.createElement("div");
  viewers.className = "viewers";
  viewers.textContent = `üëÅÔ∏è Viewers: ${stream.viewers || 0}`;

  const timer = document.createElement("div");
  timer.className = "timer";

  if(isLive){
    const liveTag = document.createElement("div");
    liveTag.className = "live";
    liveTag.textContent = "LIVE";
    card.appendChild(liveTag);
    timer.textContent = "";
  } else {
    updateCountdown(timer, stream.starts_at);
  }

  info.appendChild(catLabel);
  info.appendChild(title);
  info.appendChild(viewers);
  info.appendChild(timer);
  card.appendChild(img);
  card.appendChild(info);

  card.addEventListener("click", ()=>openPlayer(stream.iframe));
  return card;
}

async function updateLiveViewers(){
  try{
    const res = await fetch("https://ppv.to/api/streams");
    const data = await res.json();
    const now = Math.floor(Date.now()/1000);

    data.streams.forEach(group=>{
      group.streams.forEach(stream=>{
        if(now >= stream.starts_at && now <= stream.ends_at){
          const card = [...document.querySelectorAll(".card")].find(c => c.querySelector(".title").textContent===stream.name);
          if(card){
            const viewersEl = card.querySelector(".viewers");
            viewersEl.textContent = `üëÅÔ∏è Viewers: ${stream.viewers || 0}`;
          }
        }
      });
    });
  }catch(e){
    console.error("Failed to update viewers:", e);
  }
}

function updateCountdown(el,startTime){
  const now = Math.floor(Date.now()/1000);
  const diff = startTime - now;
  if(diff<=0){
    el.textContent="Happening now!";
    el.classList.add("soon");
    return true;
  }
  const days=Math.floor(diff/86400);
  const hours=Math.floor((diff%86400)/3600);
  const mins=Math.floor((diff%3600)/60);
  const secs=diff%60;
  el.textContent=`Starts in ${days}d ${hours}h ${mins}m ${secs}s`;
  if(diff<=600) el.classList.add("soon");
  else el.classList.remove("soon");
  return false;
}

function startCountdownUpdates(){
  if(intervalId) clearInterval(intervalId);
  intervalId = setInterval(()=>{
    let changed = false;
    document.querySelectorAll(".card").forEach(card=>{
      const timer = card.querySelector(".timer");
      if(timer){
        const startTime = parseInt(card.dataset.startTime);
        const shouldLive = updateCountdown(timer,startTime);
        if(shouldLive && !card.querySelector(".live")){
          changed = true;
        }
      }
    });
    if(changed) displayStreams(allStreams);
    updateLiveViewers(); // refresh viewers count every second
  },1000);
}

function openPlayer(url){
  const container=document.getElementById("playerContainer");
  const iframe=document.getElementById("player");
  iframe.src=url+"?noads=true";
  container.style.display="block";
  document.body.style.overflow="hidden";
}

document.getElementById("closeBtn").addEventListener("click",()=>{
  const container=document.getElementById("playerContainer");
  const iframe=document.getElementById("player");
  iframe.src="";
  container.style.display="none";
  document.body.style.overflow="auto";
});

const searchBar=document.getElementById("searchBar");
searchBar.addEventListener("input",()=>{
  const term=searchBar.value.toLowerCase();
  if(!term) return displayStreams(allStreams);

  const filtered=allStreams.map(group=>{
    const streams=group.streams.filter(s => s.name.toLowerCase().includes(term) || s.tag.toLowerCase().includes(term) || group.category.toLowerCase().includes(term));
    return {category:group.category, streams};
  }).filter(g=>g.streams.length>0);

  displayStreams(filtered);
});

loadStreams();
</script>
</body>
</html>
